<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•é€€å‡ºè¯Šæ–­å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
        }
        .section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .action {
            margin: 10px 0;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .result.success {
            border-color: #28a745;
            color: #155724;
        }
        .result.error {
            border-color: #dc3545;
            color: #721c24;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç™»å½•é€€å‡ºè¯Šæ–­å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å¸®åŠ©è¯Šæ–­å’Œè§£å†³æ— æ³•é€€å‡ºç™»å½•çš„é—®é¢˜ã€‚</p>

        <div class="section">
            <h3>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€</h3>
            <div class="action">
                <button class="btn" onclick="checkCurrentSession()">æ£€æŸ¥å½“å‰ä¼šè¯</button>
            </div>
            <div id="session-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ—„ï¸ ç¬¬äºŒæ­¥ï¼šå¼ºåˆ¶æ¸…ç†ä¼šè¯</h3>
            <div class="info">
                <strong>è¯´æ˜ï¼š</strong>å¦‚æœæ£€æŸ¥åˆ°ä¼šè¯å¡ä½ï¼Œå°è¯•æ¸…ç†æ‰€æœ‰æœ¬åœ°ä¼šè¯ã€‚
            </div>
            <div class="action">
                <button class="btn danger" onclick="forceClearSessions()">å¼ºåˆ¶æ¸…ç†æ‰€æœ‰ä¼šè¯</button>
            </div>
            <div id="clear-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ§¹ ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥æœ¬åœ°å­˜å‚¨</h3>
            <div class="action">
                <button class="btn" onclick="checkLocalStorage()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
                <button class="btn" onclick="clearLocalStorage()">æ¸…ç†æœ¬åœ°å­˜å‚¨</button>
            </div>
            <div id="storage-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ”„ ç¬¬å››æ­¥ï¼šé‡ç½®æµè§ˆå™¨çŠ¶æ€</h3>
            <div class="info">
                <strong>è¯´æ˜ï¼š</strong>æ¸…ç†æµè§ˆå™¨ç¼“å­˜å’Œä¼šè¯ï¼Œé‡æ–°åŠ è½½é¡µé¢ã€‚
            </div>
            <div class="action">
                <button class="btn" onclick="refreshPage()">é‡æ–°åŠ è½½é¡µé¢</button>
                <button class="btn" onclick="hardRefresh()">å¼ºåˆ¶åˆ·æ–°ï¼ˆCtrl+F5ï¼‰</button>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ” ç¬¬äº”æ­¥ï¼šæ‰‹åŠ¨æµ‹è¯• Supabase è¿æ¥</h3>
            <div class="action">
                <button class="btn" onclick="testSupabaseConnection()">æµ‹è¯•è¿æ¥</button>
                <button class="btn" onclick="testLogout()">æµ‹è¯•ç™»å‡ºåŠŸèƒ½</button>
            </div>
            <div id="test-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ“‹ ç¬¬å…­æ­¥ï¼šç”Ÿæˆè¯Šæ–­æŠ¥å‘Š</h3>
            <div class="action">
                <button class="btn" onclick="generateReport()">ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š</button>
            </div>
            <div id="report-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ“ è§£å†³æ–¹æ¡ˆæ¨è</h3>
            <div id="solutions" class="info">
                <strong>æ ¹æ®è¯Šæ–­ç»“æœï¼Œæ¨èçš„è§£å†³æ–¹æ¡ˆï¼š</strong>
                <ol>
                    <li>å¦‚æœä¼šè¯å¡ä½ï¼šå¼ºåˆ¶æ¸…ç†ä¼šè¯</li>
                    <li>å¦‚æœæœ¬åœ°å­˜å‚¨å¼‚å¸¸ï¼šæ¸…ç†æµè§ˆå™¨ç¼“å­˜</li>
                    <li>å¦‚æœæµè§ˆå™¨é—®é¢˜ï¼šä½¿ç”¨æ— ç—•æ¨¡å¼</li>
                    <li>å¦‚æœç½‘ç»œé—®é¢˜ï¼šæ£€æŸ¥é˜²ç«å¢™è®¾ç½®</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xlamtnjlxzulahvumafh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsYW10bmpseHp1bGFodnVtYWZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjYzMTYsImV4cCI6MjA3OTU0MjMxNn0.CbHe3A7qQYbMseUVmPUD3FBzSOmCR7OgFDmAtJIkHkw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function checkCurrentSession() {
            const resultDiv = document.getElementById('session-result');
            resultDiv.innerHTML = '<div class="status">æ£€æŸ¥ä¸­...</div>';

            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">âŒ ä¼šè¯æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
                } else if (session && session.user) {
                    resultDiv.innerHTML = `<div class="status success">âœ… å½“å‰æœ‰æ´»è·ƒä¼šè¯</div>
                    resultDiv.innerHTML += `<div>ç”¨æˆ·: ${session.user.email}</div>`;
                    resultDiv.innerHTML += `<div>ä¼šè¯ID: ${session.access_token.substring(0, 20)}...</div>`;
                    resultDiv.innerHTML += `<div>åˆ›å»ºæ—¶é—´: ${new Date(session.created_at).toLocaleString()}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status">âŒ æ²¡æœ‰æ´»è·ƒä¼šè¯</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        async function forceClearSessions() {
            const resultDiv = document.getElementById('clear-result');
            resultDiv.innerHTML = '<div class="status">æ¸…ç†ä¸­...</div>';

            try {
                // æ¸…ç†å½“å‰ä¼šè¯
                const { error: signOutError } = await supabase.auth.signOut();

                if (signOutError) {
                    resultDiv.innerHTML = `<div class="status error">âŒ ç™»å‡ºå¤±è´¥: ${signOutError.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status success">âœ… å½“å‰ä¼šè¯å·²ç™»å‡º</div>`;
                }

                // æ¸…ç†æ‰€æœ‰å¯èƒ½çš„æœ¬åœ°å­˜å‚¨
                localStorage.clear();
                sessionStorage.clear();

                // å°è¯•æ¸…ç†å…¶ä»–å¯èƒ½çš„ Supabase æœ¬åœ°å­˜å‚¨
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('supabase')) {
                        localStorage.removeItem(key);
                    }
                });

                resultDiv.innerHTML += `<div class="status success">âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…ç†</div>`;

                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);

            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ¸…ç†å¤±è´¥: ${err.message}</div>`;
            }
        }

        function checkLocalStorage() {
            const resultDiv = document.getElementById('storage-result');
            const storage = {};

            // æ£€æŸ¥ localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                storage[key] = localStorage.getItem(key);
            }

            const storageJson = JSON.stringify(storage, null, 2);
            resultDiv.innerHTML = `<div class="status">æœ¬åœ°å­˜å‚¨é¡¹ç›®æ•°: ${Object.keys(storage).length}</div>`;
            resultDiv.innerHTML += `<div class="result">${storageJson}</div>`;

            // æ£€æŸ¥ Supabase ç›¸å…³é¡¹ç›®
            const supabaseKeys = Object.keys(storage).filter(key => key.includes('supabase'));
            if (supabaseKeys.length > 0) {
                resultDiv.innerHTML += `<div class="status warning">âš ï¸ å‘ç° ${supabaseKeys.length} ä¸ª Supabase ç›¸å…³é¡¹ç›®</div>`;
            } else {
                resultDiv.innerHTML += `<div class="status success">âœ… æ— å¼‚å¸¸çš„ Supabase é¡¹ç›®</div>`;
            }
        }

        function clearLocalStorage() {
            const resultDiv = document.getElementById('storage-result');

            localStorage.clear();
            sessionStorage.clear();

            resultDiv.innerHTML = `<div class="status success">âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…ç†</div>`;

            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function refreshPage() {
            window.location.reload();
        }

        function hardRefresh() {
            // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼ˆæ¨¡æ‹Ÿ Ctrl+F5ï¼‰
            window.location.href = window.location.href + '?t=' + Date.now();
        }

        async function testSupabaseConnection() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<div class="status">æµ‹è¯•è¿æ¥ä¸­...</div>';

            try {
                const startTime = Date.now();
                const { data, error } = await supabase
                    .from('members')
                    .select('count')
                    .limit(1);

                const endTime = Date.now();
                const duration = endTime - startTime;

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status success">âœ… è¿æ¥æˆåŠŸ (${duration}ms)</div>`;
                    resultDiv.innerHTML += `<div class="result">æ•°æ®: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        async function testLogout() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<div class="status">æµ‹è¯•ç™»å‡ºåŠŸèƒ½...</div>';

            try {
                const { error } = await supabase.auth.signOut();

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">âŒ ç™»å‡ºæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status success">âœ… ç™»å‡ºåŠŸèƒ½æ­£å¸¸å·¥ä½œ</div>`;

                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ ç™»å‡ºæµ‹è¯•å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        function generateReport() {
            const resultDiv = document.getElementById('report-result');
            resultDiv.innerHTML = '<div class="status">ç”ŸæˆæŠ¥å‘Šä¸­...</div>';

            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                localStorage: {},
                sessionStorage: {},
                supabaseAuth: null,
                browserInfo: {
                    cookiesEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    language: navigator.language,
                    platform: navigator.platform
                }
            };

            // æ”¶é›†æœ¬åœ°å­˜å‚¨ä¿¡æ¯
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                report.localStorage[key] = localStorage.getItem(key);
            }

            // æ£€æŸ¥ Supabase ä¼šè¯
            try {
                report.supabaseAuth = await supabase.auth.getSession();
            } catch (err) {
                report.supabaseAuth = { error: err.message };
            }

            const reportHtml = `
                <div class="status success">âœ… è¯Šæ–­æŠ¥å‘Šå·²ç”Ÿæˆ</div>
                <div class="result">
                    <strong>ğŸ• è¯Šæ–­æ—¶é—´:</strong> ${report.timestamp}<br>
                    <strong>ğŸŒ æµè§ˆå™¨:</strong> ${report.userAgent}<br>
                    <strong>ğŸŒ å¹³å°:</strong> ${report.platform}<br>
                    <strong>ğŸŒ è¯­è¨€:</strong> ${report.language}<br>
                    <strong>ğŸŒ åœ¨çº¿çŠ¶æ€:</strong> ${report.browserInfo.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}<br>
                    <strong>ğŸª Cookie æ”¯æŒ:</strong> ${report.browserInfo.cookiesEnabled ? 'æ˜¯' : 'å¦'}<br>
                    <br>
                    <strong>ğŸ“Š æœ¬åœ°å­˜å‚¨é¡¹ç›®:</strong> ${Object.keys(report.localStorage).length} ä¸ª<br>
                    <strong>ğŸ”‘ Supabase ä¼šè¯:</strong> ${report.supabaseAuth.session ? 'æœ‰' : 'æ— '}<br>
                    <br>
                    <strong>ğŸ“‹ å®Œæ•´æŠ¥å‘Š:</strong><br>
                    <pre>${JSON.stringify(report, null, 2)}</pre>
                </div>
            `;

            resultDiv.innerHTML = reportHtml;

            // è‡ªåŠ¨ä¸‹è½½æŠ¥å‘Š
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logout-diagnosis-${Date.now()}.json`;
            a.click();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ä¼šè¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkCurrentSession, 500);
        });
    </script>
</body>
</html>