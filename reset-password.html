<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…’åº—å‘˜å·¥ç®¡ç†ç³»ç»Ÿ - é‡ç½®å¯†ç </title>
    <link rel="stylesheet" href="css/auth.css">
</head>
<body class="auth-body">
    <div class="auth-container">
        <div class="auth-card">
            <header class="auth-header">
                <h1>é‡ç½®å¯†ç </h1>
                <p class="auth-subtitle">è®¾ç½®æ–°å¯†ç </p>
            </header>

            <div class="auth-form-container" id="reset-form">
                <form class="auth-form" id="reset-password-form">
                    <div class="form-group">
                        <label for="new-password">æ–°å¯†ç </label>
                        <input type="password" id="new-password" name="newPassword" required
                               placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" minlength="6">
                        <button type="button" class="password-toggle" onclick="togglePassword('new-password')">
                            <span class="eye-icon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">ç¡®è®¤æ–°å¯†ç </label>
                        <input type="password" id="confirm-password" name="confirmPassword" required
                               placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                        <button type="button" class="password-toggle" onclick="togglePassword('confirm-password')">
                            <span class="eye-icon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">
                        é‡ç½®å¯†ç 
                    </button>
                </form>

                <div class="auth-footer">
                    <p>è¿”å›
                        <button type="button" class="link-button" onclick="goToLogin()">
                            ç™»å½•é¡µé¢
                        </button>
                    </p>
                </div>
            </div>

            <!-- æˆåŠŸæç¤º -->
            <div class="auth-form-container hidden" id="success-message">
                <div class="verification-message">
                    <div class="verification-icon">âœ…</div>
                    <h2>å¯†ç é‡ç½®æˆåŠŸ</h2>
                    <p>æ‚¨çš„å¯†ç å·²æˆåŠŸé‡ç½®</p>
                    <div class="verification-actions">
                        <button type="button" class="btn btn-primary btn-full" onclick="goToLogin()">
                            è¿”å›ç™»å½•
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message" class="message"></div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <p>å¤„ç†ä¸­...</p>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://xlamtnjlxzulahvumafh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsYW10bmpseHp1bGFodnVtYWZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjYzMTYsImV4cCI6MjA3OTU0MjMxNn0.CbHe3A7qQYbMseUVmPUD3FBzSOmCR7OgFDmAtJIkHkw';

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM å…ƒç´ 
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šè¡¨å•äº‹ä»¶
            document.getElementById('reset-password-form').addEventListener('submit', handleResetPassword);

            // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰é‡ç½®ä»¤ç‰Œ
            checkResetToken();
        });

        // æ£€æŸ¥é‡ç½®ä»¤ç‰Œ
        async function checkResetToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token');

            if (!accessToken || !refreshToken) {
                showMessage('æ— æ•ˆçš„é‡ç½®é“¾æ¥', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            // è®¾ç½®ä¼šè¯
            const { data, error } = await supabase.auth.setSession({
                access_token: accessToken,
                refresh_token: refreshToken
            });

            if (error) {
                showMessage('é‡ç½®é“¾æ¥å·²è¿‡æœŸæˆ–æ— æ•ˆ', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            console.log('é‡ç½®ä»¤ç‰ŒéªŒè¯æˆåŠŸ');
        }

        // å¤„ç†å¯†ç é‡ç½®
        async function handleResetPassword(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');

            // éªŒè¯è¾“å…¥
            if (!newPassword || !confirmPassword) {
                showMessage('è¯·å¡«å†™å®Œæ•´çš„å¯†ç ä¿¡æ¯', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            showLoading();

            try {
                const { data, error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    throw error;
                }

                showMessage('å¯†ç é‡ç½®æˆåŠŸï¼', 'success');

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                document.getElementById('reset-form').classList.add('hidden');
                document.getElementById('success-message').classList.remove('hidden');

            } catch (error) {
                console.error('é‡ç½®å¯†ç å¤±è´¥:', error);
                showMessage('é‡ç½®å¯†ç å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // å·¥å…·å‡½æ•°
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('.eye-icon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                icon.textContent = 'ğŸ‘ï¸';
            }
        }

        function showLoading() {
            loading.classList.remove('hidden');
        }

        function hideLoading() {
            loading.classList.add('hidden');
        }

        function showMessage(text, type = 'info') {
            message.textContent = text;
            message.className = `message ${type} show`;

            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }

        function goToLogin() {
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>