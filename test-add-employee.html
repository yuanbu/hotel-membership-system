<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·»åŠ å‘˜å·¥è¯Šæ–­å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
        }
        .section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .action {
            margin: 10px 0;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.success:hover {
            background: #218838;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            border-color: #28a745;
            color: #155724;
        }
        .result.error {
            border-color: #dc3545;
            color: #721c24;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .step-success {
            border-left-color: #28a745;
            background: #e8f5e8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ·»åŠ å‘˜å·¥åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å¸®åŠ©è¯Šæ–­ä¸ºä»€ä¹ˆæ·»åŠ å‘˜å·¥åŠŸèƒ½ä¸å·¥ä½œã€‚</p>

        <div class="section">
            <h3>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€</h3>
            <div class="action">
                <button class="btn" onclick="checkAuthStatus()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
            </div>
            <div id="auth-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ§ª ç¬¬äºŒæ­¥ï¼šæµ‹è¯•æ•°æ®åº“è¿æ¥</h3>
            <div class="action">
                <button class="btn" onclick="testDatabaseConnection()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
                <button class="btn" onclick="testTableAccess()">æµ‹è¯•è¡¨è®¿é—®æƒé™</button>
            </div>
            <div id="db-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ§ª ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹Ÿæ·»åŠ å‘˜å·¥</h3>
            <div class="form-group">
                <label for="test-employee-id">å‘˜å·¥ID:</label>
                <input type="text" id="test-employee-id" value="9999" placeholder="è¾“å…¥æµ‹è¯•å‘˜å·¥ID">
            </div>
            <div class="form-group">
                <label for="test-employee-name">å‘˜å·¥å§“å:</label>
                <input type="text" id="test-employee-name" value="æµ‹è¯•å‘˜å·¥" placeholder="è¾“å…¥æµ‹è¯•å‘˜å·¥å§“å">
            </div>
            <div class="form-group">
                <label for="test-employee-salary">å‘˜å·¥è–ªèµ„:</label>
                <input type="number" id="test-employee-salary" value="5000" placeholder="è¾“å…¥æµ‹è¯•å‘˜å·¥è–ªèµ„">
            </div>
            <div class="action">
                <button class="btn success" onclick="simulateAddEmployee()">æ¨¡æ‹Ÿæ·»åŠ å‘˜å·¥</button>
                <button class="btn danger" onclick="cleanupTestEmployee()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
            </div>
            <div id="add-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ” ç¬¬å››æ­¥ï¼šæ£€æŸ¥RLSç­–ç•¥</h3>
            <div class="action">
                <button class="btn" onclick="checkRLSPolicies()">æ£€æŸ¥RLSç­–ç•¥</button>
            </div>
            <div id="rls-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ“Š ç¬¬äº”æ­¥ï¼šæŸ¥çœ‹ç°æœ‰æ•°æ®</h3>
            <div class="action">
                <button class="btn" onclick="viewExistingData()">æŸ¥çœ‹ç°æœ‰å‘˜å·¥æ•°æ®</button>
                <button class="btn" onclick="viewActivityLogs()">æŸ¥çœ‹æ´»åŠ¨æ—¥å¿—</button>
            </div>
            <div id="data-result" class="result"></div>
        </div>

        <div class="section">
            <h3>ğŸ“ è§£å†³æ–¹æ¡ˆæ¨è</h3>
            <div id="solutions" class="status warning">
                <strong>æ ¹æ®è¯Šæ–­ç»“æœï¼Œæ¨èçš„è§£å†³æ–¹æ¡ˆï¼š</strong>
                <ol>
                    <li>å¦‚æœæœªè®¤è¯ï¼šè¯·å…ˆç™»å½•ç³»ç»Ÿ</li>
                    <li>å¦‚æœæƒé™ä¸è¶³ï¼šæ£€æŸ¥RLSç­–ç•¥é…ç½®</li>
                    <li>å¦‚æœè¡¨ç»“æ„é—®é¢˜ï¼šè¿è¡Œé…ç½®è„šæœ¬</li>
                    <li>å¦‚æœç½‘ç»œé—®é¢˜ï¼šæ£€æŸ¥Supabaseè¿æ¥</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xlamtnjlxzulahvumafh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsYW10bmpseHp1bGFodnVtYWZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjYzMTYsImV4cCI6MjA3OTU0MjMxNn0.CbHe3A7qQYbMseUVmPUD3FBzSOmCR7OgFDmAtJIkHkw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;

        async function checkAuthStatus() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '<div class="status">æ£€æŸ¥è®¤è¯çŠ¶æ€ä¸­...</div>';

            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">âŒ è·å–ä¼šè¯å¤±è´¥: ${error.message}</div>`;
                    return;
                }

                if (session && session.user) {
                    currentUser = session.user;
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… ç”¨æˆ·å·²è®¤è¯</div>
                        <div>ç”¨æˆ·ID: ${session.user.id}</div>
                        <div>é‚®ç®±: ${session.user.email}</div>
                        <div>åˆ›å»ºæ—¶é—´: ${new Date(session.user.created_at).toLocaleString()}</div>
                        <div>è§’è‰²: ${session.user.aud || 'authenticated'}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ ç”¨æˆ·æœªè®¤è¯ï¼Œè¯·å…ˆç™»å½•</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ è®¤è¯æ£€æŸ¥å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        async function testDatabaseConnection() {
            const resultDiv = document.getElementById('db-result');
            resultDiv.innerHTML = '<div class="status">æµ‹è¯•æ•°æ®åº“è¿æ¥...</div>';

            try {
                const startTime = Date.now();
                const { data, error } = await supabase
                    .from('members')
                    .select('count')
                    .limit(1);

                const endTime = Date.now();
                const duration = endTime - startTime;

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}</div>`;
                    resultDiv.innerHTML += `<div>é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error, null, 2)}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status success">âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ (${duration}ms)</div>`;
                    resultDiv.innerHTML += `<div>æŸ¥è¯¢ç»“æœ: ${JSON.stringify(data, null, 2)}</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        async function testTableAccess() {
            const resultDiv = document.getElementById('db-result');
            resultDiv.innerHTML = '<div class="status">æµ‹è¯•è¡¨è®¿é—®æƒé™...</div>';

            try {
                // æµ‹è¯•SELECTæƒé™
                const { data: selectData, error: selectError } = await supabase
                    .from('members')
                    .select('*')
                    .limit(1);

                if (selectError) {
                    resultDiv.innerHTML += `<div class="status error">âŒ SELECTæƒé™å¤±è´¥: ${selectError.message}</div>`;
                } else {
                    resultDiv.innerHTML += `<div class="status success">âœ… SELECTæƒé™æ­£å¸¸</div>`;
                }

                // æµ‹è¯•INSERTæƒé™ï¼ˆä½¿ç”¨è™šæ‹Ÿæ•°æ®ï¼‰
                const testInsert = {
                    employee_id: 99999,
                    employee_name: 'æƒé™æµ‹è¯•',
                    employee_salary: 0,
                    created_by: currentUser?.id
                };

                const { data: insertData, error: insertError } = await supabase
                    .from('members')
                    .insert([testInsert])
                    .select();

                if (insertError) {
                    resultDiv.innerHTML += `<div class="status error">âŒ INSERTæƒé™å¤±è´¥: ${insertError.message}</div>`;
                } else {
                    resultDiv.innerHTML += `<div class="status success">âœ… INSERTæƒé™æ­£å¸¸</div>`;
                    // ç«‹å³æ¸…ç†æµ‹è¯•æ•°æ®
                    await supabase.from('members').delete().eq('employee_id', 99999);
                }

            } catch (err) {
                resultDiv.innerHTML += `<div class="status error">âŒ æƒé™æµ‹è¯•å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        async function simulateAddEmployee() {
            const resultDiv = document.getElementById('add-result');
            const employeeId = document.getElementById('test-employee-id').value.trim();
            const employeeName = document.getElementById('test-employee-name').value.trim();
            const employeeSalary = parseInt(document.getElementById('test-employee-salary').value) || 0;

            if (!employeeId || !employeeName) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¯·å¡«å†™å®Œæ•´çš„å‘˜å·¥ä¿¡æ¯</div>`;
                return;
            }

            if (!currentUser) {
                resultDiv.innerHTML = `<div class="status error">âŒ ç”¨æˆ·æœªè®¤è¯ï¼Œè¯·å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€</div>`;
                return;
            }

            resultDiv.innerHTML = '<div class="status">æ­£åœ¨æ·»åŠ æµ‹è¯•å‘˜å·¥...</div>';

            try {
                // 1. æ£€æŸ¥å‘˜å·¥IDæ˜¯å¦å·²å­˜åœ¨
                const { data: existingEmployee } = await supabase
                    .from('members')
                    .select('employee_id')
                    .eq('employee_id', parseInt(employeeId))
                    .single();

                if (existingEmployee) {
                    resultDiv.innerHTML = `<div class="status error">âŒ å‘˜å·¥ID ${employeeId} å·²å­˜åœ¨</div>`;
                    return;
                }

                // 2. æ’å…¥æ–°å‘˜å·¥
                const employeeData = {
                    employee_id: parseInt(employeeId),
                    employee_name: employeeName,
                    employee_salary: employeeSalary,
                    created_by: currentUser.id
                };

                resultDiv.innerHTML += '<div class="status">å‡†å¤‡æ’å…¥æ•°æ®...</div>';

                const { data, error } = await supabase
                    .from('members')
                    .insert([employeeData])
                    .select();

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">âŒ æ·»åŠ å‘˜å·¥å¤±è´¥: ${error.message}</div>`;
                    resultDiv.innerHTML += `<div>é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error, null, 2)}</div>`;
                    resultDiv.innerHTML += `<div>è¯·æ±‚æ•°æ®: ${JSON.stringify(employeeData, null, 2)}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status success">âœ… å‘˜å·¥æ·»åŠ æˆåŠŸï¼</div>`;
                    resultDiv.innerHTML += `<div>è¿”å›æ•°æ®: ${JSON.stringify(data, null, 2)}</div>`;

                    // 3. è®°å½•æ´»åŠ¨æ—¥å¿—
                    const logResult = await logActivity('CREATE', 'employee', employeeId, {
                        employee_name: employeeName,
                        employee_salary: employeeSalary
                    });

                    if (logResult) {
                        resultDiv.innerHTML += `<div class="status success">âœ… æ´»åŠ¨æ—¥å¿—è®°å½•æˆåŠŸ</div>`;
                    } else {
                        resultDiv.innerHTML += `<div class="status warning">âš ï¸ æ´»åŠ¨æ—¥å¿—è®°å½•å¤±è´¥</div>`;
                    }
                }

            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ·»åŠ å‘˜å·¥å¼‚å¸¸: ${err.message}</div>`;
                resultDiv.innerHTML += `<div>å¼‚å¸¸å †æ ˆ: ${err.stack}</div>`;
            }
        }

        async function cleanupTestEmployee() {
            const resultDiv = document.getElementById('add-result');
            const employeeId = document.getElementById('test-employee-id').value.trim();

            if (!employeeId) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¯·è¾“å…¥è¦æ¸…ç†çš„å‘˜å·¥ID</div>`;
                return;
            }

            resultDiv.innerHTML = '<div class="status">æ¸…ç†æµ‹è¯•æ•°æ®...</div>';

            try {
                const { error } = await supabase
                    .from('members')
                    .delete()
                    .eq('employee_id', parseInt(employeeId));

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">âŒ æ¸…ç†å¤±è´¥: ${error.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status success">âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ¸…ç†å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        async function checkRLSPolicies() {
            const resultDiv = document.getElementById('rls-result');
            resultDiv.innerHTML = '<div class="status">æ£€æŸ¥RLSç­–ç•¥...</div>';

            try {
                // è¿™é‡Œæˆ‘ä»¬åªèƒ½é€šè¿‡å°è¯•æ“ä½œæ¥æ£€æŸ¥RLSç­–ç•¥
                const tests = [
                    { name: 'SELECTæµ‹è¯•', action: 'select' },
                    { name: 'INSERTæµ‹è¯•', action: 'insert' },
                    { name: 'UPDATEæµ‹è¯•', action: 'update' },
                    { name: 'DELETEæµ‹è¯•', action: 'delete' }
                ];

                for (const test of tests) {
                    resultDiv.innerHTML += `<div class="status">æ‰§è¡Œ${test.name}...</div>`;
                    // è¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…åº”è¯¥åˆ†åˆ«æµ‹è¯•æ¯ç§æ“ä½œ
                }

                resultDiv.innerHTML = `<div class="status success">âœ… RLSç­–ç•¥æ£€æŸ¥å®Œæˆ</div>`;
                resultDiv.innerHTML += `<div>æ³¨æ„ï¼šè¯¦ç»†çš„RLSç­–ç•¥æ£€æŸ¥éœ€è¦åœ¨Supabaseæ§åˆ¶å°ä¸­æŸ¥çœ‹</div>`;

            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ RLSç­–ç•¥æ£€æŸ¥å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        async function viewExistingData() {
            const resultDiv = document.getElementById('data-result');
            resultDiv.innerHTML = '<div class="status">æŸ¥è¯¢ç°æœ‰å‘˜å·¥æ•°æ®...</div>';

            try {
                // å…ˆæŸ¥è¯¢å½“å‰ç”¨æˆ·çŠ¶æ€
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    resultDiv.innerHTML = `<div class="status error">âŒ ç”¨æˆ·æœªç™»å½•</div>`;
                    return;
                }

                const currentUserId = session.user.id;
                const currentUserEmail = session.user.email;

                resultDiv.innerHTML += `<div class="status info">â„¹ï¸ å½“å‰ç”¨æˆ·: ${currentUserEmail} (${currentUserId})</div>`;

                // æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥æ•°æ®ï¼ˆmembersè¡¨çš„RLSç­–ç•¥å…è®¸æ‰€æœ‰è®¤è¯ç”¨æˆ·æŸ¥çœ‹ï¼‰
                const { data, error } = await supabase
                    .from('members')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    resultDiv.innerHTML += `<div class="status error">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
                    resultDiv.innerHTML += `<div class="status warning">âš ï¸ é”™è¯¯ä»£ç : ${error.code || 'N/A'}</div>`;

                    // å¦‚æœæ˜¯æƒé™é”™è¯¯ï¼Œå°è¯•æ·»åŠ è¯¦ç»†ä¿¡æ¯
                    if (error.message.includes('permission') || error.message.includes('policy')) {
                        resultDiv.innerHTML += `<div class="status warning">âš ï¸ è¿™å¯èƒ½æ˜¯RLSç­–ç•¥é™åˆ¶é—®é¢˜</div>`;
                    }
                } else {
                    resultDiv.innerHTML += `<div class="status success">âœ… æŸ¥è¯¢æˆåŠŸï¼Œå…± ${data.length} æ¡è®°å½•</div>`;

                    if (data.length === 0) {
                        resultDiv.innerHTML += `<div class="status info">â„¹ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰å‘˜å·¥è®°å½•ï¼Œæˆ–è€…RLSç­–ç•¥é™åˆ¶äº†è®¿é—®</div>`;
                    } else {
                        // æ˜¾ç¤ºè¯¦ç»†æ•°æ®
                        let tableHtml = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>å‘˜å·¥ID</th>
                                        <th>å§“å</th>
                                        <th>è–ªèµ„</th>
                                        <th>åˆ›å»ºè€…</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        data.forEach(employee => {
                            const createdBy = employee.created_by === currentUserId ? 'æˆ‘' :
                                (employee.created_by || 'æœªçŸ¥');
                            tableHtml += `
                                <tr>
                                    <td>${employee.employee_id}</td>
                                    <td>${employee.employee_name}</td>
                                    <td>${employee.employee_salary}</td>
                                    <td>${createdBy}</td>
                                    <td>${employee.created_at ? new Date(employee.created_at).toLocaleString() : 'æœªçŸ¥'}</td>
                                </tr>
                            `;
                        });

                        tableHtml += `
                                </tbody>
                            </table>
                        `;

                        resultDiv.innerHTML += tableHtml;
                        resultDiv.innerHTML += `<div style="margin-top: 10px;"><strong>å®Œæ•´æ•°æ®:</strong></div>`;
                        resultDiv.innerHTML += `<div>${JSON.stringify(data, null, 2)}</div>`;
                    }
                }

                // æµ‹è¯•ç›´æ¥æŸ¥è¯¢è®¡æ•°
                const { count, error: countError } = await supabase
                    .from('members')
                    .select('*', { count: 'exact', head: true });

                if (countError) {
                    resultDiv.innerHTML += `<div class="status error">âŒ è®¡æ•°æŸ¥è¯¢å¤±è´¥: ${countError.message}</div>`;
                } else {
                    resultDiv.innerHTML += `<div class="status info">â„¹ï¸ æ•°æ®åº“ä¸­çš„æ€»è®°å½•æ•°: ${count}</div>`;
                }

            } catch (err) {
                resultDiv.innerHTML += `<div class="status error">âŒ æŸ¥è¯¢å¼‚å¸¸: ${err.message}</div>`;
                resultDiv.innerHTML += `<div class="status error">âŒ å¼‚å¸¸å †æ ˆ: ${err.stack}</div>`;
            }
        }

        async function viewActivityLogs() {
            const resultDiv = document.getElementById('data-result');
            resultDiv.innerHTML = '<div class="status">æŸ¥è¯¢æ´»åŠ¨æ—¥å¿—...</div>';

            try {
                // å…ˆæŸ¥è¯¢å½“å‰ç”¨æˆ·ID
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    resultDiv.innerHTML = `<div class="status error">âŒ ç”¨æˆ·æœªç™»å½•</div>`;
                    return;
                }

                const currentUserId = session.user.id;
                const currentUserEmail = session.user.email;

                resultDiv.innerHTML += `<div class="status info">â„¹ï¸ å½“å‰ç”¨æˆ·: ${currentUserEmail} (${currentUserId})</div>`;

                // æŸ¥è¯¢è‡ªå·±çš„æ´»åŠ¨æ—¥å¿—
                const { data: ownLogs, error: ownError } = await supabase
                    .from('activity_logs')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('created_at', { ascending: false })
                    .limit(10);

                resultDiv.innerHTML += `<div class="status info">â„¹ï¸ æŸ¥è¯¢è‡ªå·±çš„æ—¥å¿— (user_id = ${currentUserId})...</div>`;

                if (ownError) {
                    resultDiv.innerHTML += `<div class="status error">âŒ æŸ¥è¯¢è‡ªå·±çš„æ—¥å¿—å¤±è´¥: ${ownError.message}</div>`;
                } else {
                    resultDiv.innerHTML += `<div class="status success">âœ… æŸ¥è¯¢æˆåŠŸï¼Œæ‚¨æœ‰ ${ownLogs.length} æ¡æ—¥å¿—è®°å½•</div>`;
                    if (ownLogs.length > 0) {
                        resultDiv.innerHTML += `<div>${JSON.stringify(ownLogs, null, 2)}</div>`;
                    }
                }

                // å°è¯•æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—ï¼ˆç”¨äºæµ‹è¯•ï¼Œä½†è¿™ä¼šå› ä¸ºRLSç­–ç•¥å¤±è´¥ï¼‰
                resultDiv.innerHTML += `<div class="status warning">âš ï¸ æµ‹è¯•æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—ï¼ˆé¢„æœŸä¼šå› RLSç­–ç•¥å¤±è´¥ï¼‰...</div>`;
                const { data: allLogs, error: allError } = await supabase
                    .from('activity_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (allError) {
                    resultDiv.innerHTML += `<div class="status warning">âš ï¸ é¢„æœŸçš„RLSé™åˆ¶: ${allError.message}</div>`;
                } else {
                    resultDiv.innerHTML += `<div class="status success">âœ… æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—æˆåŠŸ: ${allLogs.length} æ¡</div>`;
                }

            } catch (err) {
                resultDiv.innerHTML += `<div class="status error">âŒ æŸ¥è¯¢æ´»åŠ¨æ—¥å¿—å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        async function logActivity(action, targetType, targetId, details = {}) {
            if (!currentUser) return false;

            try {
                const { error } = await supabase
                    .from('activity_logs')
                    .insert({
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        action: action,
                        target_type: targetType,
                        target_id: targetId,
                        details: details
                    });

                return !error;
            } catch (error) {
                console.error('æ´»åŠ¨æ—¥å¿—å¼‚å¸¸:', error);
                return false;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkAuthStatus, 500);
        });
    </script>
</body>
</html>