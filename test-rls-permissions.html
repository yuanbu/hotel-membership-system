<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLSæƒé™è¯¦ç»†æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
        }
        .section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .action {
            margin: 10px 0;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.success:hover {
            background: #218838;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        .btn.warning:hover {
            background: #e0a800;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            max-height: 500px;
            overflow-y: auto;
        }
        .result.success {
            border-color: #28a745;
            color: #155724;
        }
        .result.error {
            border-color: #dc3545;
            color: #721c24;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .test-case {
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            padding: 15px;
            background: #f9f9f9;
        }
        .test-case h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” RLSæƒé™è¯¦ç»†æµ‹è¯•</h1>
        <p>ä¸“é—¨æµ‹è¯•RLSç­–ç•¥å¯¹æ•°æ®è®¿é—®çš„å½±å“</p>

        <div class="section">
            <h3>ğŸ‘¤ å½“å‰ç”¨æˆ·çŠ¶æ€</h3>
            <div class="action">
                <button class="btn" onclick="checkUserStatus()">æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</button>
            </div>
            <div id="user-status" class="result">ç‚¹å‡»æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</div>
        </div>

        <div class="section">
            <h3>ğŸ§ª membersè¡¨æƒé™æµ‹è¯•</h3>
            <div class="action">
                <button class="btn" onclick="testMembersPermissions()">æ‰§è¡Œæ‰€æœ‰æµ‹è¯•</button>
            </div>
            <div id="members-tests" class="result">ç‚¹å‡»æ‰§è¡Œæµ‹è¯•</div>
        </div>

        <div class="section">
            <h3>ğŸ§ª activity_logsè¡¨æƒé™æµ‹è¯•</h3>
            <div class="action">
                <button class="btn" onclick="testActivityLogsPermissions()">æ‰§è¡Œæ‰€æœ‰æµ‹è¯•</button>
            </div>
            <div id="activity-tests" class="result">ç‚¹å‡»æ‰§è¡Œæµ‹è¯•</div>
        </div>

        <div class="section">
            <h3>ğŸ” æ•°æ®åº“ç›´æ¥æŸ¥è¯¢</h3>
            <div class="action">
                <button class="btn" onclick="directQueryTest()">æ‰§è¡Œç›´æ¥æŸ¥è¯¢æµ‹è¯•</button>
            </div>
            <div id="direct-query" class="result">ç‚¹å‡»æ‰§è¡Œç›´æ¥æŸ¥è¯¢æµ‹è¯•</div>
        </div>

        <div class="section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœåˆ†æ</h3>
            <div id="analysis" class="status info">
                <strong>æµ‹è¯•å®Œæˆåï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºåˆ†æç»“æœ</strong>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xlamtnjlxzulahvumafh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsYW10bmpseHp1bGFodnVtYWZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjYzMTYsImV4cCI6MjA3OTU0MjMxNn0.CbHe3A7qQYbMseUVmPUD3FBzSOmCR7OgFDmAtJIkHkw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let testResults = {};

        async function checkUserStatus() {
            const resultDiv = document.getElementById('user-status');
            resultDiv.innerHTML = '<div class="status">æ£€æŸ¥ç”¨æˆ·çŠ¶æ€...</div>';

            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">âŒ è·å–ä¼šè¯å¤±è´¥: ${error.message}</div>`;
                    return;
                }

                if (session && session.user) {
                    currentUser = session.user;
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… ç”¨æˆ·å·²è®¤è¯</div>
                        <div><strong>ç”¨æˆ·ID:</strong> ${session.user.id}</div>
                        <div><strong>é‚®ç®±:</strong> ${session.user.email}</div>
                        <div><strong>è§’è‰²:</strong> ${session.user.aud || 'authenticated'}</div>
                        <div><strong>ä¼šè¯åˆ›å»º:</strong> ${new Date(session.created_at).toLocaleString()}</div>
                        <div><strong>ä»¤ç‰Œè¿‡æœŸ:</strong> ${new Date(session.expires_at * 1000).toLocaleString()}</div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="status error">âŒ ç”¨æˆ·æœªè®¤è¯</div>';
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¼‚å¸¸: ${err.message}</div>`;
            }
        }

        async function testMembersPermissions() {
            const resultDiv = document.getElementById('members-tests');
            resultDiv.innerHTML = '<div class="status">å¼€å§‹æµ‹è¯•membersè¡¨æƒé™...</div>';

            if (!currentUser) {
                await checkUserStatus();
                if (!currentUser) {
                    resultDiv.innerHTML = '<div class="status error">âŒ ç”¨æˆ·æœªè®¤è¯ï¼Œæ— æ³•æµ‹è¯•æƒé™</div>';
                    return;
                }
            }

            const tests = [
                {
                    name: 'æµ‹è¯•1: æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥ï¼ˆåº”è¯¥æˆåŠŸï¼‰',
                    action: () => supabase.from('members').select('*').limit(5),
                    expected: 'success'
                },
                {
                    name: 'æµ‹è¯•2: è®¡æ•°æŸ¥è¯¢ï¼ˆåº”è¯¥æˆåŠŸï¼‰',
                    action: () => supabase.from('members').select('*', { count: 'exact', head: true }),
                    expected: 'success'
                },
                {
                    name: 'æµ‹è¯•3: æ’å…¥æ–°å‘˜å·¥ï¼ˆåº”è¯¥æˆåŠŸï¼‰',
                    action: () => supabase.from('members').insert({
                        employee_id: Math.floor(Math.random() * 90000) + 10000,
                        employee_name: 'æƒé™æµ‹è¯•å‘˜å·¥',
                        employee_salary: 3000,
                        created_by: currentUser.id
                    }).select(),
                    expected: 'success'
                },
                {
                    name: 'æµ‹è¯•4: æ›´æ–°å‘˜å·¥ï¼ˆåº”è¯¥æˆåŠŸï¼‰',
                    action: () => supabase.from('members')
                        .update({ employee_salary: 4000 })
                        .eq('employee_id', 1)
                        .select(),
                    expected: 'success'
                },
                {
                    name: 'æµ‹è¯•5: åˆ é™¤å‘˜å·¥ï¼ˆåº”è¯¥æˆåŠŸï¼‰',
                    action: () => supabase.from('members')
                        .delete()
                        .eq('employee_id', 2)
                        .select(),
                    expected: 'warning' // å¯èƒ½å› ä¸ºæ•°æ®ä¸å­˜åœ¨è€Œå¤±è´¥
                }
            ];

            let results = '';

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                results += `<div class="test-case">`;
                results += `<h4>${test.name}</h4>`;
                results += `<div class="status">æ‰§è¡Œä¸­...</div>`;

                try {
                    const startTime = Date.now();
                    const { data, error } = await test.action();
                    const duration = Date.now() - startTime;

                    if (error) {
                        const isError = test.expected === 'error';
                        results += `<div class="status ${isError ? 'success' : 'error'}">
                            ${isError ? 'âœ…' : 'âŒ'} ${error.message} (${duration}ms)
                        </div>`;
                    } else {
                        const isSuccess = test.expected === 'success';
                        results += `<div class="status ${isSuccess ? 'success' : 'warning'}">
                            ${isSuccess ? 'âœ…' : 'âš ï¸'} æˆåŠŸè¿”å›æ•°æ® (${duration}ms)
                        </div>`;
                        results += `<div>è¿”å›è®°å½•æ•°: ${Array.isArray(data) ? data.length : (data ? 1 : 0)}</div>`;

                        if (Array.isArray(data) && data.length > 0) {
                            results += `<div>æ•°æ®ç¤ºä¾‹: ${JSON.stringify(data.slice(0, 1), null, 2)}</div>`;
                        }
                    }
                } catch (err) {
                    results += `<div class="status error">âŒ å¼‚å¸¸: ${err.message}</div>`;
                }

                results += `</div>`;
            }

            testResults.members = results;
            resultDiv.innerHTML = results;
            analyzeResults();
        }

        async function testActivityLogsPermissions() {
            const resultDiv = document.getElementById('activity-tests');
            resultDiv.innerHTML = '<div class="status">å¼€å§‹æµ‹è¯•activity_logsè¡¨æƒé™...</div>';

            if (!currentUser) {
                resultDiv.innerHTML = '<div class="status error">âŒ ç”¨æˆ·æœªè®¤è¯ï¼Œæ— æ³•æµ‹è¯•æƒé™</div>';
                return;
            }

            const tests = [
                {
                    name: 'æµ‹è¯•1: æŸ¥è¯¢æ‰€æœ‰æ—¥å¿—ï¼ˆåº”è¯¥è¢«RLSé™åˆ¶ï¼‰',
                    action: () => supabase.from('activity_logs').select('*').limit(5),
                    expected: 'error'
                },
                {
                    name: 'æµ‹è¯•2: æŸ¥è¯¢è‡ªå·±çš„æ—¥å¿—ï¼ˆåº”è¯¥æˆåŠŸï¼‰',
                    action: () => supabase.from('activity_logs')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .limit(5),
                    expected: 'success'
                },
                {
                    name: 'æµ‹è¯•3: æ’å…¥è‡ªå·±çš„æ—¥å¿—ï¼ˆåº”è¯¥æˆåŠŸï¼‰',
                    action: () => supabase.from('activity_logs').insert({
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        action: 'CREATE',
                        target_type: 'test',
                        target_id: 'test',
                        details: { test: true }
                    }).select(),
                    expected: 'success'
                },
                {
                    name: 'æµ‹è¯•4: æ’å…¥ä»–äººæ—¥å¿—ï¼ˆåº”è¯¥å¤±è´¥ï¼‰',
                    action: () => supabase.from('activity_logs').insert({
                        user_id: '00000000-0000-0000-0000-000000000000',
                        user_email: 'test@example.com',
                        action: 'CREATE',
                        target_type: 'test',
                        target_id: 'test',
                        details: { test: true }
                    }).select(),
                    expected: 'error'
                }
            ];

            let results = '';

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                results += `<div class="test-case">`;
                results += `<h4>${test.name}</h4>`;
                results += `<div class="status">æ‰§è¡Œä¸­...</div>`;

                try {
                    const startTime = Date.now();
                    const { data, error } = await test.action();
                    const duration = Date.now() - startTime;

                    if (error) {
                        const isError = test.expected === 'error';
                        results += `<div class="status ${isError ? 'success' : 'error'}">
                            ${isError ? 'âœ… é¢„æœŸé™åˆ¶' : 'âŒ æ„å¤–å¤±è´¥'} ${error.message} (${duration}ms)
                        </div>`;
                    } else {
                        const isSuccess = test.expected === 'success';
                        results += `<div class="status ${isSuccess ? 'success' : 'warning'}">
                            ${isSuccess ? 'âœ… é¢„æœŸæˆåŠŸ' : 'âš ï¸ æ„å¤–æˆåŠŸ'} (${duration}ms)
                        </div>`;
                        results += `<div>è¿”å›è®°å½•æ•°: ${Array.isArray(data) ? data.length : (data ? 1 : 0)}</div>`;
                    }
                } catch (err) {
                    results += `<div class="status error">âŒ å¼‚å¸¸: ${err.message}</div>`;
                }

                results += `</div>`;
            }

            testResults.activity_logs = results;
            resultDiv.innerHTML = results;
            analyzeResults();
        }

        async function directQueryTest() {
            const resultDiv = document.getElementById('direct-query');
            resultDiv.innerHTML = '<div class="status">æ‰§è¡Œç›´æ¥æŸ¥è¯¢æµ‹è¯•...</div>';

            const queries = [
                {
                    name: 'æŸ¥è¯¢æ€»å‘˜å·¥æ•°',
                    query: () => supabase.from('members').select('*', { count: 'exact', head: true })
                },
                {
                    name: 'æŸ¥è¯¢æ€»æ—¥å¿—æ•°',
                    query: () => supabase.from('activity_logs').select('*', { count: 'exact', head: true })
                },
                {
                    name: 'æŸ¥è¯¢å‘˜å·¥è¯¦æƒ…',
                    query: () => supabase.from('members').select('*').limit(3)
                },
                {
                    name: 'æŸ¥è¯¢æœ€æ–°æ—¥å¿—',
                    query: () => supabase.from('activity_logs').select('*').order('created_at', { ascending: false }).limit(3)
                }
            ];

            let results = '';

            for (const q of queries) {
                results += `<div class="test-case">`;
                results += `<h4>${q.name}</h4>`;

                try {
                    const startTime = Date.now();
                    const { data, error, count } = await q.query();
                    const duration = Date.now() - startTime;

                    if (error) {
                        results += `<div class="status error">âŒ å¤±è´¥: ${error.message}</div>`;
                        if (error.code) {
                            results += `<div>é”™è¯¯ä»£ç : ${error.code}</div>`;
                        }
                    } else {
                        results += `<div class="status success">âœ… æˆåŠŸ (${duration}ms)</div>`;
                        if (count !== undefined) {
                            results += `<div>è®¡æ•°: ${count}</div>`;
                        }
                        if (data) {
                            results += `<div>è®°å½•æ•°: ${Array.isArray(data) ? data.length : 1}</div>`;
                            if (Array.isArray(data) && data.length > 0) {
                                results += `<div>æ•°æ®: ${JSON.stringify(data, null, 2)}</div>`;
                            }
                        }
                    }
                } catch (err) {
                    results += `<div class="status error">âŒ å¼‚å¸¸: ${err.message}</div>`;
                }

                results += `</div>`;
            }

            resultDiv.innerHTML = results;
        }

        function analyzeResults() {
            const analysisDiv = document.getElementById('analysis');

            if (!testResults.members || !testResults.activity_logs) {
                return; // ç­‰å¾…æ‰€æœ‰æµ‹è¯•å®Œæˆ
            }

            let analysis = '<strong>ğŸ“Š æµ‹è¯•ç»“æœåˆ†æï¼š</strong><br><br>';

            // åˆ†æmembersè¡¨
            analysis += 'ğŸ”¹ <strong>membersè¡¨ï¼š</strong><br>';
            if (testResults.members.includes('âœ…')) {
                analysis += 'âœ… membersè¡¨RLSç­–ç•¥å·¥ä½œæ­£å¸¸ï¼Œè®¤è¯ç”¨æˆ·å¯ä»¥è®¿é—®<br>';
            } else {
                analysis += 'âŒ membersè¡¨RLSç­–ç•¥å¯èƒ½æœ‰é—®é¢˜ï¼Œæ£€æŸ¥ç­–ç•¥é…ç½®<br>';
            }

            // åˆ†æactivity_logsè¡¨
            analysis += 'ğŸ”¹ <strong>activity_logsè¡¨ï¼š</strong><br>';
            if (testResults.activity_logs.includes('é¢„æœŸé™åˆ¶') && testResults.activity_logs.includes('é¢„æœŸæˆåŠŸ')) {
                analysis += 'âœ… activity_logsè¡¨RLSç­–ç•¥å·¥ä½œæ­£å¸¸ï¼Œæ­£ç¡®é™åˆ¶äº†æ•°æ®è®¿é—®<br>';
            } else {
                analysis += 'âŒ activity_logsè¡¨RLSç­–ç•¥å¯èƒ½æœ‰é—®é¢˜<br>';
            }

            // æ€»ä½“å»ºè®®
            analysis += '<br><strong>ğŸ› ï¸ å»ºè®®ï¼š</strong><br>';
            analysis += '1. å¦‚æœmembersè¡¨æµ‹è¯•å¤±è´¥ï¼Œæ£€æŸ¥RLSç­–ç•¥æ˜¯å¦æ­£ç¡®å¯ç”¨<br>';
            analysis += '2. å¦‚æœactivity_logsæµ‹è¯•ä¸ç¬¦åˆé¢„æœŸï¼Œç¡®è®¤user_idå­—æ®µåŒ¹é…<br>';
            analysis += '3. ç¡®ä¿ç”¨æˆ·é‚®ç®±å·²éªŒè¯ä¸”è®¤è¯ä»¤ç‰Œæœ‰æ•ˆ<br>';
            analysis += '4. æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒSupabaseæœåŠ¡çŠ¶æ€<br>';

            analysisDiv.innerHTML = analysis;
            analysisDiv.className = 'status info';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkUserStatus, 500);
        });
    </script>
</body>
</html>